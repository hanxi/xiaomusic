<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- PWAå¿…é¡»çš„é…ç½® -->
        <link rel="manifest" href="/manifest.json">
        <title>MiniéŸ³ä¹æ’­æ”¾å™¨</title>
        <style>
        /* æ–°å¢éŸ³é‡æ§åˆ¶æ ·å¼ */
        .volume-control {
            position: relative;
            align-items: center;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 30px;
        }

        .btn-volume {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
        }

        .volume-slider {
            width: 100px;
            height: 4px;
            -webkit-appearance: none;
            background: #ddd;
            border-radius: 2px;
            outline: none;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .volume-slider:hover {
            opacity: 1;
        }

        /* è‡ªå®šä¹‰æ»‘åŠ¨æ¡æ ·å¼ */
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #ff4d4d;
            border-radius: 50%;
            cursor: pointer;
        }
        body {
            background: #f5f5f5;
            font-family: Arial, "Microsoft Yahei";
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* æ’­æ”¾å™¨å®¹å™¨ */
        .player {
            background: #fff;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* å°é¢å›¾ç‰‡ */
        .cover {
            width: 200px;
            height: 200px;
            border-radius: 10px;
            margin: 0 auto 20px;
            overflow: hidden;
            background: #ddd;
        }

        .cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* æ­Œæ›²ä¿¡æ¯ */
        .song-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .song-title {
            font-size: 18px;
            margin: 5px 0;
        }

        .artist {
            color: #666;
            font-size: 14px;
        }

        /* è¿›åº¦æ¡ */
        .progress-container {
            width: 100%;
            height: 4px;
            background: #eee;
            border-radius: 2px;
            margin: 15px 0;
            cursor: pointer;
        }

        .progress {
            height: 100%;
            background: #ff4d4d;
            width: 0%;
            border-radius: 2px;
            transition: width 0.1s linear;
        }

        /* æ—¶é—´æ˜¾ç¤º */
        .time {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 20px;
        }

        .btn {
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .btn-play {
            background: #ff4d4d;
            color: white;
            width: 50px;
            height: 50px;
        }

        .btn:hover {
            background: #ff6666;
        }

        /* æ­Œæ›²åˆ—è¡¨ */
        .playlist {
            margin-top: 20px;
            list-style: none;
            padding: 0;
        }

        .playlist li {
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .playlist li:hover {
            background: #f8f8f8;
        }

        .playlist li.playing {
            background: #ffe5e5;
            color: #ff4d4d;
        }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    </head>
    <body>
        <script> // è¿æ¥åˆ°æœåŠ¡ç«¯ 
        const socket = io("/", { transports: ["websocket"] }); 
        socket.on('connect', () => {
            console.log('Connected to the server');
            socket.emit('my_event', 'Hello, server!');
        });

        // æ¥æ”¶å¹¿æ’­æ¶ˆæ¯ 
        socket.on("response", (data) => { const div = document.createElement("div"); 
            div.textContent = `${data.action}: ${data.status}`; 


            if( data.action=='play')
        {
                playlist[0].src=data.args;
                playlist[0].artist="å°çˆ±åœ¨çº¿"
                playlist[0].title="å°çˆ±åœ¨çº¿"
                console.log(data.args)
                playSong(0) ;
            }
            if( data.action=='stop')
        {
                togglePlay() 
            }
            const audio = document.getElementById('audio');
            const volumeSlider = document.getElementById('volumeSlider');
            if( data.action=='volume')
        {


                audio.volume=data.args/100
                volumeSlider.value=audio.volume
            }
            if( data.action=='down')
        {
                audio.volume=audio.volume-0.2
                volumeSlider.value=audio.volume
            }
            if( data.action=='up')
        {
                audio.volume=audio.volume+0.2
                volumeSlider.value=audio.volume
            }
            document.getElementById("messages").appendChild(div); }); 
        </script>

        <div class="player">

            <div class="cover">
                <img id="cover-image" src="https://tse4-mm.cn.bing.net/th/id/OIP-C.ou-y715Of4TbrAPN-j96sQHaEj?w=309&h=188&c=7&r=0&o=5&pid=1.7" alt="å°é¢">
            </div>

            <div class="song-info">
                <h2 class="song-title" id="song-title">Let Go</h2>
                <p class="artist" id="artist">Avril Lavigne</p>
            </div>

            <div class="progress-container" id="progress-container">
                <div class="progress" id="progress"></div>
            </div>

            <div class="time">
                <span id="current-time">00:00</span>
                <span id="duration">00:00</span>
            </div>

            <div class="controls">
                <div class="btn btn-prev" onclick="prevSong()">â®</div>
                <div class="btn btn-play" id="playBtn" onclick="togglePlay()">â–¶</div>
                <div class="btn btn-next" onclick="nextSong()">â­</div>
            </div>
            <br>
            <!-- æ–°å¢éŸ³é‡æ§åˆ¶ -->
            <div class="volume-control">
                <button class="btn-volume" onclick="toggleMute()">ğŸ”Š</button>
                <input type="range" 
                    id="volumeSlider" 
                    class="volume-slider" 
                    min="0" 
                    max="1" 
                    step="0.1" 
                    value="1">
            </div>
            <ul class="playlist" id="playlist"></ul>
        </div>

        <audio id="audio" src="" ></audio>


        <script>
        // åœ¨åˆå§‹åŒ–ä»£ç ä¸­æ·»åŠ 
        document.body.addEventListener('touchstart', function initAudio() {
            audio.load(); // iOSéœ€è¦é¢„åŠ è½½
            document.body.removeEventListener('touchstart', initAudio);
        });
        // éŸ³ä¹æ•°æ®
        const playlist = [
            {
                title: "ä¸€å‰ªæ¢…",
                artist: "æœªçŸ¥",
                cover: "https://tse4-mm.cn.bing.net/th/id/OIP-C.ou-y715Of4TbrAPN-j96sQHaEj?w=309&h=188&c=7&r=0&o=5&pid=1.7",
                src: "/static/3thdplay.mp3"
            } 
        ];

        const audio = document.getElementById('audio');
        const playBtn = document.getElementById('playBtn');
        let currentSongIndex = 0;
        let isPlaying = false;
        let wakeLock = null;
        let audioContext = null;
        // åœ¨æ’­æ”¾å‰é¢„å¤„ç†é“¾æ¥
        function ensureRangeSupport(url) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                xhr.open('HEAD', url);
                xhr.onload = () => {
                    if (xhr.getResponseHeader('Accept-Ranges')) {
                        resolve(url);
                    } else {
                        resolve(`${url}?force_range=true`); // å…¼å®¹ä¸æ”¯æŒçš„æœåŠ¡ç«¯
                    }
                };
                xhr.send();
            });
        }
        // åˆå§‹åŒ–æ’­æ”¾åˆ—è¡¨
        function initPlaylist() {
            const playlistEl = document.getElementById('playlist');
            playlist.forEach((song, index) => {
                const li = document.createElement('li');
                li.innerHTML = `${song.title} - ${song.artist}`;
                li.onclick = () => playSong(index);
                playlistEl.appendChild(li);
            });

            // ä»…åŠ è½½ç¬¬ä¸€é¦–ä½†ä¸æ’­æ”¾

            const firstSong = playlist[0];
            document.getElementById('song-title').textContent = firstSong.title;
            document.getElementById('artist').textContent = firstSong.artist;
            document.getElementById('cover-image').src = firstSong.cover;
            audio.src = firstSong.src;
        }
        let isFirstPlay = true;
        // æ’­æ”¾æ­Œæ›²
        async   function playSong(index) {
            currentSongIndex = index;
            const song = playlist[index];
            const src = await ensureRangeSupport(song.src);
            document.getElementById('song-title').textContent = song.title;
            document.getElementById('artist').textContent = song.artist;
            document.getElementById('cover-image').src = song.cover;
            audio.src = src

            // æ›´æ–°æ’­æ”¾åˆ—è¡¨æ ·å¼
            document.querySelectorAll('#playlist li').forEach((li, i) => {
                li.classList.toggle('playing', i === index);
            });
            // åªæœ‰å½“ä¸æ˜¯é¦–æ¬¡æ’­æ”¾æ—¶æ‰è‡ªåŠ¨æ’­æ”¾
            if (!isFirstPlay) {
                audio.play().catch(error => {
                    console.log('æ’­æ”¾è¯·æ±‚è¢«é˜»æ­¢:', error);

                });
                playBtn.textContent = 'â¸';
                isPlaying = true;
            }
        }

        // åˆ‡æ¢æ’­æ”¾/æš‚åœ
        async    function togglePlay() {
            if (isFirstPlay) {
                // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶è§¦å‘ç”¨æˆ·æ‰‹åŠ¿
                console.log("---firest play-----")
                await   audio.play()
                .then(() => {
                    isFirstPlay = false;
                    isPlaying = true;
                    playBtn.textContent = 'â¸';
                    //    audio.play(); // æš‚åœç­‰å¾…ç”¨æˆ·æ“ä½œ

                })
                .catch(error => {
                    alert('è¯·ç‚¹å‡»æ­¤å¤„å¼€å§‹æ’­æ”¾');
                });
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaElementSource(audio);
                    source.connect(audioContext.destination);
                    // è¯·æ±‚ä¿æŒå”¤é†’
                    console.log('---------init audiocontest')
                }
                await requestWakeLock();

                return;
            }

            if (isPlaying) {
                audio.pause();
                playBtn.textContent = 'â–¶';
            } else {
                await audio.play();
                playBtn.textContent = 'â¸';
            }
            isPlaying = !isPlaying;
        }

        // ä¸‹ä¸€é¦–
        function nextSong() {
            currentSongIndex = (currentSongIndex + 1) % playlist.length;
            playSong(currentSongIndex);
        }

        // ä¸Šä¸€é¦–
        function prevSong() {
            currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
            playSong(currentSongIndex);
        }

        // æ’­æ”¾è¿›åº¦æ›´æ–°
        audio.addEventListener('timeupdate', function() {
            const progress = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progress').style.width = `${progress}%`;

            document.getElementById('current-time').textContent = 
                formatTime(audio.currentTime);
        });

        // æ€»æ—¶é•¿æ˜¾ç¤º
        audio.addEventListener('loadedmetadata', function() {
            document.getElementById('duration').textContent = 
                formatTime(audio.duration);
        });

        // ç‚¹å‡»è¿›åº¦æ¡è·³è½¬
        const progressContainer = document.getElementById('progress-container');
        progressContainer.addEventListener('click', function(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            audio.currentTime = (clickX / width) * audio.duration;
        });

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’ â†’ mm:ssï¼‰
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        // åœ¨ JavaScript ä¸­æ–°å¢ä»¥ä¸‹ä»£ç 
        const volumeSlider = document.getElementById('volumeSlider');
        let isMuted = false;
        let lastVolume = 1;

        // éŸ³é‡æ»‘åŠ¨æ¡æ§åˆ¶
        volumeSlider.addEventListener('input', (e) => {
            audio.volume = e.target.value;
            if (audio.volume === '0') {
                document.querySelector('.btn-volume').textContent = 'ğŸ”‡';
            } else {
                document.querySelector('.btn-volume').textContent = 
                    audio.volume > 0.5 ? 'ğŸ”Š' : 'ğŸ”‰';
            }
            isMuted = false; // å–æ¶ˆé™éŸ³çŠ¶æ€
        });

        // é™éŸ³åˆ‡æ¢
        function toggleMute() {
            isMuted = !isMuted;
            if (isMuted) {
                lastVolume = audio.volume;
                audio.volume = 0;
                volumeSlider.value = 0;
                document.querySelector('.btn-volume').textContent = 'ğŸ”‡';
            } else {
                audio.volume = lastVolume;
                volumeSlider.value = lastVolume;
                document.querySelector('.btn-volume').textContent = 
                    lastVolume > 0.5 ? 'ğŸ”Š' : 'ğŸ”‰';
            }
        }
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        updateStatus('å±å¹•é”å·²é‡Šæ”¾');
                    });
                }
            } catch (err) {
                console.warn('Wake Lock é”™è¯¯:', err);
            }

            // å…¼å®¹iOSå¤„ç†
            if (/(iPhone|iPad)/i.test(navigator.userAgent)) {
                audio.setAttribute('playsinline', 'true');
                audio.setAttribute('webkit-playsinline', 'true');
            }
        }
        // åˆå§‹åŒ–Service Worker
        //console.log('Service Worker æ³¨å†ŒæˆåŠŸ');
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').then(() => {
                console.log('Service Worker æ³¨å†ŒæˆåŠŸ');
            });
        }
        // åˆå§‹åŒ–éŸ³é‡ï¼ˆé»˜è®¤1ï¼‰
        audio.volume = 1;
        // è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€é¦–
        audio.addEventListener('ended', nextSong);

        // åˆå§‹åŒ–
        initPlaylist();
        //  playSong(0); 
        </script>
        <div id="messages"></div>
    </body>
</html>
